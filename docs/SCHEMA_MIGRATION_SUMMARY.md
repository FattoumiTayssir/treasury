# PostgreSQL Schema Migration Summary

## Changes Made

### 1. Updated PostgreSQL Schema
**File**: `/home/mss_ds/treasury/init/postgres/10-schema.sql`

Extended the `Manual_Entry` table with new columns to match treasury_b:
- `start_date` (DATE) - Start date for recurrence
- `timezone` (VARCHAR(64)) - Timezone for date calculations
- `recurrence` (JSONB) - Recurrence configuration object
- `rrule` (VARCHAR(512)) - RFC 5545 recurrence rule string
- `metadata` (JSONB) - Additional metadata for manual entries

### 2. Created Migration Script
**File**: `/home/mss_ds/treasury/init/postgres/15-alter-manual-entry.sql`

This migration script:
- Adds the new columns to existing Manual_Entry tables
- Uses conditional logic to avoid errors if columns already exist
- Initializes `start_date` to CURRENT_DATE and `timezone` to 'UTC' for existing rows

### 3. Created Rollback Script
**File**: `/home/mss_ds/treasury/init/postgres/16-rollback-manual-entry.sql`

Rollback script to remove the new columns if needed.

## ETL Compatibility

All ETL scripts are **fully compatible** with the schema changes:
- `etl_jobs/achat_importation_upsert.py`
- `etl_jobs/ventes_locales_upsert.py`
- `etl_jobs/achats_locaux_echeance_upsert.py`

**Why?** The ETL scripts only insert into `Movement` and `Exception` tables, setting `manual_entry_id` to NULL. They do not interact with the `Manual_Entry` table directly.

## Setup Instructions

### For Fresh Database
The schema will automatically include the new columns when you start the postgres container:

```bash
# Start postgres with the updated schema
docker-compose up -d postgres

# Wait for postgres to be healthy
docker-compose ps
```

### For Existing Database
If you already have a database with the old schema, apply the migration:

```bash
# Apply migration to existing database
docker-compose exec postgres psql -U postgres -d appdb -f /docker-entrypoint-initdb.d/15-alter-manual-entry.sql
```

Or manually run the migration from your host:

```bash
PGPASSWORD=your_password psql -h 127.0.0.1 -U postgres -d appdb < init/postgres/15-alter-manual-entry.sql
```

## Running ETL Jobs with Poetry

### 1. Ensure PostgreSQL is Running
```bash
docker-compose up -d postgres
```

### 2. Configure Environment
Make sure your `.env` file has the required Odoo credentials:
```bash
cp .env.example .env
# Edit .env with your actual credentials
```

Required env vars:
- `POSTGRES_PASSWORD` - PostgreSQL password
- `ODOO_URL` - Odoo instance URL
- `ODOO_DB` - Odoo database name
- `ODOO_USERNAME` - Odoo username
- `ODOO_PASSWORD` - Odoo password

### 3. Run All ETLs in Parallel
```bash
poetry run python run_all_etls.py
```

This will:
- Run all 3 ETL jobs in parallel
- Provide comprehensive logging to console and `etl_execution.log`
- Show a summary with success/failure counts and duration
- Exit with code 1 if any ETL fails, 0 if all succeed

### 4. Run Individual ETL Jobs
```bash
# Achat Importation (CE% invoices)
poetry run python etl_jobs/achat_importation_upsert.py

# Ventes Locales (local sales, unpaid invoices)
poetry run python etl_jobs/ventes_locales_upsert.py

# Achats Locaux avec Échéance (local purchases with future due dates)
poetry run python etl_jobs/achats_locaux_echeance_upsert.py
```

## Testing the Setup

### Quick Test
```bash
# 1. Start postgres
docker-compose up -d postgres

# 2. Verify schema
docker-compose exec postgres psql -U postgres -d appdb -c "\d Manual_Entry"

# Expected output should show the new columns:
# - start_date
# - timezone
# - recurrence
# - rrule
# - metadata

# 3. Run ETLs (requires Odoo credentials in .env)
poetry run python run_all_etls.py
```

## Rollback (If Needed)

To remove the new columns and revert to the old schema:

```bash
PGPASSWORD=your_password psql -h 127.0.0.1 -U postgres -d appdb < init/postgres/16-rollback-manual-entry.sql
```

## Schema Comparison

### Before (Old Schema)
```sql
CREATE TABLE Manual_Entry (
  manual_entry_id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  frequency       VARCHAR(20) NOT NULL,
  dates_list      JSONB       NOT NULL
);
```

### After (New Schema)
```sql
CREATE TABLE Manual_Entry (
  manual_entry_id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  frequency       VARCHAR(20) NOT NULL,
  dates_list      JSONB       NOT NULL,
  start_date      DATE,
  timezone        VARCHAR(64),
  recurrence      JSONB,
  rrule           VARCHAR(512),
  metadata        JSONB
);
```

## Notes

- The schema now matches treasury_b's Manual_Entry structure (adapted for PostgreSQL)
- All new columns are nullable to maintain backward compatibility
- ETL jobs continue to work without modification
- Fresh database initializations will include all columns automatically
- Existing databases need the migration script applied once
